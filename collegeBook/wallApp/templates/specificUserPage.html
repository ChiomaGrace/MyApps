<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" 
    integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <title>CollegeBook</title>
    {% load static %}	<!-- Need this line to use static images -->
    <link rel="stylesheet" href="{% static 'css/collegeWall.css' %}">  <!-- Need this line to use external stylesheet -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script> <!-- Order matters..important to load bootstrap before jquery ui to avoid button method conflicts -->
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js"></script> <!-- Need this line to use pop up dialog boxes -->
    <script>
        $(document).ready(function() { 

            var $crf_token = $('[name="csrfmiddlewaretoken"]').attr('value'); //this defines the token form the form so it can be used in the jquery/ajax code below

        //The below code are function calls that run as soon as the window is loaded.

            showThumbnail(); // a function that determines whether or not a photo has been uploaded by a user and then acts accordingly

            enableDisableMessageButton(); // a function that enables and disables the post a message button

            $('.postACommentButton').prop('disabled', true); //This disables the comment button to start


        //The above code are function calls that run as soon as the window is loaded.

            function showThumbnail(e) {
                $('#navIconProfPic').hide()
                console.log("Show Thumbnail function")
                console.log("This is the thumbnail uploaded:",thumbnail)
                console.log("Length", thumbnail.height)
                if (thumbnail.height > 0) {
                    console.log("There is an image")
                    $('#profilePicContainer').css("border", "3px solid white") //This changes the border of the thumbnail when a photo is successfully uploaded
                    // $('#linkForNavIconProfPic').show() //Shows a smaller version of the submitted profile pic in the navigation bar
                    console.log("End of if statement")
                }
                else{
                // if (thumbnail.length < 0){
                    console.log("There is not an image.")
                    // $('#linkForNavIconProfPic').hide() //This hides the default thumbnail in the navigation bar if there is no photo currently
                    // $('#navIconProfPic').hide() //This hides the default thumbnail in the navigation bar if there is no photo currently
                    console.log("End of if statement")
                }
            };

            //The below code is the function for posting a message via jquery/ajax

            $("#postAMessageForm").submit(function(e){// the id name given to the form action in the below html
                    console.log("The post a message button was clicked.")
                    e.preventDefault(); //prevents the default browser behavior of the form submitting normally
                    var messageData = {
                        "userMessage": $('#userMessageID').val(), //the key name must match the name in the views/form but the value name must differentiate
                        "userWhoReceivesPost": $('#userWhoReceivesPostID').val(), //the key name must match the name in the views/form but the value name must differentiate
                    };
                    console.log("The form data was submitted.", messageData)
                    $.ajax({
                        type: "POST",
                        url: "{% url 'processMessage' userFirstName=specificUsersPage.firstName userLastName=specificUsersPage.lastName userId=specificUsersPage.id %}",
                        headers:{"X-CSRFToken": $crf_token}, //this relates to the CSRF token in the form
                        data: messageData,
                        success: function(data) {
                                console.log("This is the data successfully submitted", data)
                                location.reload(); //reloads the page and displays the new data.
                        },
                        error: function(data){
                            console.log("If this console log is displaying, it means errors occurred in submitting the user profile info data.")
                        },
                    });
                });

            //The above code is the function for posting a message via jquery/ajax

    //The below code is the function that enables and disables the post a message button depending on if the textarea contains characters
        function enableDisableMessageButton(e){
            console.log("This is the enableDisableMessageButton function.")
            $('#postAMessageButton').prop('disabled', true); //This disables the button
            var submittedPost = document.getElementById("userMessageID"); //element that will be the focus of the keyup
            var showMessageButton = function() { 
                if (submittedPost.value !== '') {
                    console.log("This console log means the text area is not blank, and the post a message button should be enabled.")
                    $("#postAMessageButton").attr('disabled',false)
                } 
                else if (submittedPost.value == '')  {
                    console.log("This console log means the text area is blank, and the post a message button should be disabled.")
                    $("#postAMessageButton").attr('disabled',true)
                }
            }
            submittedPost.onkeyup = showMessageButton; //The keyup event is sent to an element when the user releases a key on the keyboard. This will then trigger the showMessageButton()
        }

    //The above code is the function that enables and disables the post a message button depending on if the textarea contains characters

            //The below code is the function for posting a comment via jquery/ajax

            $("#postACommentForm").submit(function(e){// the id name given to the form action in the below html
                    console.log("The post a comment button was clicked.")
                    e.preventDefault(); //prevents the default browser behavior of the form submitting normally
                    var commentData = {
                        "userComment": $('#userCommentID').val(), //the key name must match the name in the views/form but the value name must differentiate
                        "userReceivesComment": $('#userReceivesCommentID').val(), //the key name must match the name in the views/form but the value name must differentiate
                        "postLocationForComment": $('#postLocationForCommentID').val(), //the key name must match the name in the views/form but the value name must differentiate
                    };
                    console.log("The form data was submitted.", commentData)
                    $.ajax({
                        type: "POST",
                        url: "{% url 'processComment' userFirstName=specificUsersPage.firstName userLastName=specificUsersPage.lastName userId=specificUsersPage.id %}",
                        headers:{"X-CSRFToken": $crf_token}, //this relates to the CSRF token in the form
                        data: commentData,
                        success: function(data) {
                                console.log("This is the data successfully submitted", data)
                                location.reload(); //reloads the page and displays the new data.
                        },
                        error: function(data){
                            console.log("If this console log is displaying, it means errors occurred in submitting the user profile info data.")
                        },
                    });
                });

            //The above code is the function for posting a comment via jquery/ajax
        
//The below code is the function that enables and disables the post a comment button depending on if the textarea contains characters

            $('.commentSubDiv').find('textarea').each(function(){  //This function creates a loop finding all the text areas within the div
                $(".commentTextAreaOnForm").keyup(function() { //This function then tracks the user's typing within said text area
                        console.log("inside the keyup function")
                        typedComment = $(this).val();
                        // console.log(typedComment)
                    if (typedComment == '')  {
                        console.log("This console log means the text area is blank, and the post a comment button should be disabled.")
                        $(this).siblings('.postACommentButton').attr('disabled',true)
                    }
                    else if (typedComment !== '') {
                        console.log("This console log means the text area is not blank, and the post a comment button should be enabled.")
                        $(this).siblings('.postACommentButton').attr('disabled',false)
                    } 
                })
            });

//The above code is the function that enables and disables the post a comment button depending on if the textarea contains characters

        });//end of entire code in the script
    </script>
</head>

<body class="bg-light">
    <!--The below code is for the navigation bar  -->

    <nav class="navbar navbar-expand-lg navbar-blue bg-white" id="navBar">
        <a class="navbar-brand" href="">
            <img id="logoIcon" src="{% static 'Images/logo.png' %}" alt="A stock image of a logo with the two letters CB to represent Collegebook." />
        </a>
        <!-- <div class="col-sm-3" id="searchBarFromDiv"> -->
            <form class="form-inline col-sm-3" id="searchBarForm">
                <input class="form-control rounded-pill " id="searchBarInput" type="search" placeholder="Search CollegeBook" aria-label="Search">
                <button class="btn btn-outline-primary btn-sm ml-2" id="searchBarButton" type="submit">Search</button>
            </form>
        <!-- </div> -->
        <div class="col-sm-5 "  id="navIconsDiv mt-2">
            <button class="btn btn-outline-light my-2 my-sm-0 buttonOfNavIcons">
                <img class=" mr-3" id="navIconHome" src="{% static 'Images/home.png' %}" alt="A stock image of a logo with the two letters CB to represent Collegebook." />
            </button>
            <button class="btn btn-outline-light my-2 my-sm-0 pl-2 pr-2 buttonOfNavIcons">
                <img class="mr-3" id="navIconPage" src="{% static 'Images/pages.png' %}" alt="A stock image of a logo with the two letters CB to represent Collegebook." />
            </button>
            <button class="btn btn-outline-light my-2 my-sm-0 pl-2 pr-2 buttonOfNavIcons">
                <img class="mr-3" id="navIconWatch" src="{% static 'Images/watch.png' %}" alt="A stock image of a logo with the two letters CB to represent Collegebook." />
            </button>
            <button class="btn btn-outline-light my-2 my-sm-0 pl-2 pr-2 buttonOfNavIcons">
                <img class="mr-3" id="navIconMarketplace" src="{% static 'Images/marketplace.png' %}" alt="A stock image of a logo with the two letters CB to represent Collegebook." />
            </button>
            <button class="btn btn-outline-light my-2 my-sm-0 pl-2 pr-4 buttonOfNavIcons">
                <img class="mr-3" id="navIconGroups" src="{% static 'Images/groups.png' %}" alt="A stock image of a logo with the two letters CB to represent Collegebook." />
            </button>
        </div>
        <!-- <div class="col-sm-5">
            <!-One of three columns -->
        <!-- </div> --> 
        <div class="col-sm-3 mb-2" id="">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a id="linkForNavIconProfPic" href="/home" class="d-inline ">
                    <!-- This if statement only displays the image src when an image is uploaded -->
                    {% if not loggedInUser.profilePic == "" %}
                        <img src='{{ loggedInUser.profilePic }}' id="navIconProfPic" class="d-inline"> 
                    {% endif %}
                    </a>
                    <li class="nav-item">
                        <a class="nav-link" href="/home">{{loggedInUser.firstName}}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="">Messenger</a>
                    </li>

                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="" id="dropdownSymbol" role="button" data-toggle="dropdown">Account</a>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="/home">Settings</a>
                        <a class="dropdown-item" href="/home">Support</a>
                        <a class="dropdown-item" href="/home">Give Feedback</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="/logout">Log Out</a>
                    </div>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="/logout">Logout <span class="sr-only">(current)</span></a>
                </li>
            </ul>
        </div>
    </nav>
    <!-- The above code is for the navigation bar -->

    <div class="container">
        <div class="row bg-white mt-5">
            <div class="col-sm bg-white">
                <!-- One of three columns -->
            </div>
            <div class="col-sm profilePicBanner">
                    <div id="profilePicContainer">
                        <img src='{{ specificUsersPage.profilePic }}' id="thumbnail" class="uploadedPhotoProperties"> 
                    </div>
                    <h3 class="" id="userNameText">{{specificUsersPage.firstName}} {{specificUsersPage.lastName}}</h3>
                    <p class="mb-0" id="userProfileInfoTextArea">{{specificUsersPage.profileInfo}}</p>
            </div>
            <div class="col-sm bg-white">
                <!-- One of three columns -->
            </div>
        </div>

        <div class="row ml-5 mt-4">
            <div class="col-sm-3 mt-4 ml-5 bg-white friendsDiv">
                <p class="lead mr-2 pl-2">Friends</p>
                {% for user in allUsers %}
                    {% if loggedInUser.id != user.id  %} <!-- to prevent the logged in user's name displaying in the friends section -->
                        {% if user.profilePic == "" %}
                <figure class="ml-4 d-inline-block">
                    <a href="/{{user.firstName}}/{{user.lastName}}/{{user.id}}">
                        <img src="{% static 'Images/blankAvatar.png' %}" id="" class="friendsIconProfPic " alt="A thumbnail photo of the user">
                        <figcaption class="ml-2">{{user.firstName}}</figcaption>
                    </a>
                </figure>
                    <a href="/home">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-plus" viewBox="0 0 16 16">
                            <path d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H1s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C9.516 10.68 8.289 10 6 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                            <path fill-rule="evenodd" d="M13.5 5a.5.5 0 0 1 .5.5V7h1.5a.5.5 0 0 1 0 1H14v1.5a.5.5 0 0 1-1 0V8h-1.5a.5.5 0 0 1 0-1H13V5.5a.5.5 0 0 1 .5-.5z"/>
                        </svg>                                
                    </a>
                    {% else %}
                <div class="d-inline-block">
                    <figure class="ml-4">
                        <a href="/{{user.firstName}}/{{user.lastName}}/{{user.id}}">
                            <img src="{{user.profilePic}}" id="" class="friendsIconProfPic" alt="A thumbnail photo of the user">
                        </a>
                        <a href="/home">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-plus" viewBox="0 0 16 16">
                                <path d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H1s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C9.516 10.68 8.289 10 6 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                                <path fill-rule="evenodd" d="M13.5 5a.5.5 0 0 1 .5.5V7h1.5a.5.5 0 0 1 0 1H14v1.5a.5.5 0 0 1-1 0V8h-1.5a.5.5 0 0 1 0-1H13V5.5a.5.5 0 0 1 .5-.5z"/>
                            </svg>                                    
                        </a>
                        <a href="/{{user.firstName}}/{{user.lastName}}/{{user.id}}">
                            <figcaption class="ml-2">{{user.firstName}}</figcaption>
                        </a>
                    </figure>
                </div>
                        {% endif%}
                    {% endif %}
                {% endfor %}
            </div>
        
            <div class="col-sm-7 ml-5">
                <!-- The below code is for the post a message form --> 
                <form class="mb-2 bg-white col-sm-12" action="" method="post" id="postAMessageForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="textArea"></label>
                        <input type="hidden" id="userWhoReceivesPostID" name="userWhoReceivesPost" value="{{specificUsersPage.id}}">
                        <textarea class="form-control rounded-pill" id="userMessageID" name="userMessage" rows="2" placeholder="Write something to {{specificUsersPage.firstName}}... "></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary mb-2 btn-sm" id="postAMessageButton">Post A Message</button>
                </form>
                <small class="font-weight-bold">Posts</small>
                <!-- The above code is for the post a message form -->

                <table class="table table-borderless">
                    <tbody>
                        <tr>
                            <td class="border border border-light bg-white">
                            {% for message in specificUsersMessages %}
                                <div class="messageContentsDiv">
                                    {% if message.user.id == loggedInUser.id %}
                                            <a href="/home">
                                                {% if not message.user.profilePic == "" %}
                                                    <img src="{{message.user.profilePic}}" id="navIconProfPic" alt="">
                                                {% endif %}
                                                    {{message.user.firstName}} {{message.user.lastName}}
                                            </a>
                                    {% else %}
                                    <a href="/{{message.user.firstName}}/{{message.user.lastName}}/{{message.user.id}}">
                                        {% if not message.user.profilePic == "" %}
                                        <img src="{{message.user.profilePic}}" id="navIconProfPic" alt="">
                                        {% endif %}

                                        {{message.user.firstName}} {{message.user.lastName}}
                                    </a>
                                    {% endif %}
                                            {% if message.user.profilePic == "" %}
                                                <small class="d-block ml-4 text-secondary messageCreatedAt">{{message.createdAt}}</small>
                                            {% else %}
                                                <small class="d-block ml-4 text-secondary messageCreatedAtWithThumbnail">{{message.createdAt}}</small>
                                            {% endif %}
                                </div>
                                <p class="col-sm mb-0 mt-0 ml-0  messageText">{{message.message}} </p>

                                <div class=" col-sm-12 mr-3 pl-5 mt-0 bg-light">
                                    <a class="mr-2 hover" href="/like/{{message.id}}">Like</a>
                                    <a class="mr-2" href="/unlike/{{message.id}}">Unlike</a>
                                    <a class="" href="">Comment</a>
                                </div>

                                <div class="col-sm ml-5">
                                    <!-- The below line of code displays when a single user likes a message on the logged in user's page -->
                                        {% for user in message.userLikes.all%} <!--the message.userLikes.all is the many to many relationship in the message model containing all the likes the users did  -->
                                            {% if specificUsersPage.id == loggedInUser.id and message.likeMessageCount == 1 %}
                                            <small class=""> You like this </small>
                                            {% endif %}
                                            {% if specificUsersPage.id != loggedInUser.id and message.likeMessageCount == 1 %}
                                            <small class=""> {{user.firstName}} likes this </small>
                                            {% endif %}
                                    <!-- The above line of code displays when a single user likes a message on the logged in user's page  -->
                                        
                                    <!-- The below line of code displays when two users(either a user and logged in user OR two other users) like a message on the logged in user's page -->
                                            {% if specificUsersPage.id == loggedInUser.id and message.likeMessageCount == 2 %}
                                                        <small class=""> You and </small>
                                                        {% if forloop.last %}
                                                        <small class=""> {{user.firstName}} like this </small>
                                                        {% endif %}
                                            {% endif %}
    
                                            {% if specificUsersPage.id != loggedInUser.id and message.likeMessageCount == 2 %}
                                                {% if forloop.first %}
                                                    <small class=""> {{user.firstName}} and </small>
                                                {% endif %}
                                                {% if forloop.last %}
                                                    <small class=""> {{user.firstName}} like this </small>
                                                {% endif %}
                                            {% endif %}
                                    <!-- The above line of code displays when two users likes a message on the logged in user's page  -->
    
                                    <!-- The below line of code displays when three users(1 being the logged in user) like a message on the logged in user's page -->
                                            {% if specificUsersPage.id == loggedInUser.id and message.likeMessageCount == 3 %}
                                                {% if forloop.first %}
                                                    <small class=""> You, </small>
                                                {% endif %}
                                            {% endif %}
    
                                            {% if specificUsersPage.id != loggedInUser.id and message.likeMessageCount == 3 %}
                                                {% if forloop.last %}
                                                    <small class=""> {{user.firstName}}, and 1 other </small>
                                                {% endif %}
                                            {% endif %}
                                    <!-- The above line of code displays when three users(1 being the logged in user) like a message on the logged in user's page -->
    
                                    <!-- The below line of code displays when three users(none being the logged in user) like a message on the logged in user's page -->
                                            {% if specificUsersPage.id != loggedInUser.id and message.likeMessageCount == 3 %}
                                                {% if forloop.first %}
                                                    <small class=""> {{user.firstName}}, </small>
                                                    {% if specificUsersPage.id != loggedInUser.id and message.likeMessageCount == 3 %}
                                                        {% if forloop.last %}
                                                            <small class=""> {{user.firstName}}, and 1 other </small>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                    <!-- The above line of code displays when three users(none being the logged in user) like a message on the logged in user's page -->
    
                                    <!-- The below line of code displays when more than three users(1 being the logged in user) like a message on the logged in user's page -->
                                            {% if specificUsersPage.id == loggedInUser.id and message.likeMessageCount > 3 %}
                                                {% if forloop.first %}
                                                    <small class=""> You, </small>
                                                {% endif %}
                                            {% endif %}
    
                                            {% if specificUsersPage.id != loggedInUser.id and message.likeMessageCount > 3 %}
                                                {% if forloop.last %}
                                                    <small class=""> {{user.firstName}}, and {{message.likeMessageCountMinusDisplayNames}} others </small>
                                                {% endif %}
                                            {% endif %}
                                    <!-- The above line of code displays when three users(1 being the logged in user) like a message on the logged in user's page -->
                                    
                                    <!-- The below line of code displays when more than three users(none being the logged in user) like a message on the logged in user's page -->
                                            {% if specificUsersPage.id != loggedInUser.id and message.likeMessageCount > 3 %}
                                                {% if forloop.first %}
                                                    <small class=""> {{user.firstName}}, </small>
                                                {% if specificUsersPage.id != loggedInUser.id and message.likeMessageCount > 3 %}
                                                    {% if forloop.last %}
                                                        <small class=""> {{user.firstName}}, and {{message.likeMessageCountMinusDisplayNames}} others </small>
                                                    {% endif %}
                                                {% endif %}
                                                {% endif %}
                                            {% endif %}
                                    <!-- The above line of code displays when more than three users(none being the logged in user) like a message on the logged in user's page -->
    
                                        {% endfor %} <!-- The end of the message.userLikes.all loop -->
                                    </div>

                                {% for comment in message.comments.all %}
                                <!-- <p class="col-sm ml-4 sm mb-0">{{comment.user.firstName}} {{comment.user.lastName}}
                                    {{message.user.createdAt}}</p> -->
                                    <div class="commentSectionDiv row mt-2 ml-3 mb-3">
                                        <!-- <div class=""> -->
                                            <!-- </div> -->
                                            <img src="{{comment.user.profilePic}}" id="navIconProfPic" alt="" class="d-inline ml-3">
                                            <div class="badge rounded-pill bg-light commentSection ">
                                                <a href="/{{comment.user.firstName}}/{{comment.user.lastName}}/{{comment.user.id}}"  class="commentHeadText d-block">{{comment.user.firstName}} {{comment.user.lastName}}</a>
                                                <p class="commentSubText d-block">{{comment.comment}}</p>
                                            </div>
                                    </div>
                                {% endfor %}

                                <!-- The below line of code is the form to post a comment. -->
                                <form class="col-sm ml-0 sm mb-0 mt-0 pt-0 pb-0" action="{% url 'processComment' userFirstName=specificUsersPage.firstName userLastName=specificUsersPage.lastName userId=specificUsersPage.id %}" method="post" id="postACommentForm">
                                    {% csrf_token %}
                                    <div class="form-group mt-0 mb-0 commentSubDiv">
                                        <label for="textArea"></label>
                                        <input type="hidden" id="postLocationForCommentID" name="postLocationForComment" value="{{message.id}}">
                                        <input type="hidden" id="userReceivesCommentID" name="userReceivesComment" value="{{message.user.id}}">
                                    {% if not loggedInUser.profilePic == "" %}
                                        <img src="{{loggedInUser.profilePic}}" id="navIconProfPic" alt="" class="d-inline mt-3 ml-3">
                                    {% endif %}
                                        <textarea class="form-control form-control-sm col-sm-8 mt-3 rounded-pill bg-light text-black d-inline commentTextAreaOnForm" rows="1" id="userCommentID" name="userComment"></textarea>
                                        <button type="submit" id="" class="btn btn-primary mt-3 btn-success btn-sm d-inline postACommentButton">Comment</button>
                                    </div>
                                </form>
                                <!-- This above line of code is the form to post a comment. -->
                                {% endfor %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</body>

</html>